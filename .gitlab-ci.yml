# SPDX-FileCopyrightText: 2020-2026 Laurent Montel <montel@kde.org>
# SPDX-License-Identifier: CC0-1.0

include:
  - project: sysadmin/ci-utilities
    file:
      - /gitlab-templates/linux-qt6.yml
      - /gitlab-templates/linux-qt6-next.yml
      - /gitlab-templates/freebsd-qt6.yml
      - /gitlab-templates/cppcheck.yml
      - /gitlab-templates/windows-qt6.yml
      - /gitlab-templates/pre-commit.yml

build_clazy:
 extends:
  - .ci_linux_base
  - .suse_tumbleweed_qt6stable
 rules:
  # only run on merge requests
  - if: $CI_PIPELINE_SOURCE == "merge_request_event"
 variables:
    # remove/comment the CXXFLAGS if you don't want the build to fail on clazy issues
    CXXFLAGS: -Werror -Wno-deprecated-declarations
    CC: clang
    CXX: clazy
 script:
  - git config --global --add safe.directory $CI_PROJECT_DIR
  - python3 -u ci-utilities/run-ci-build.py --project $CI_PROJECT_NAME --branch $CI_COMMIT_REF_NAME --platform Linux/Qt6/Shared --only-setup-environment
  - mkdir -p /tmp/$CI_PROJECT_NAME-clazy-build
  - cd /tmp/$CI_PROJECT_NAME-clazy-build
  - cmake -DENABLE_PCH=OFF -DKF_SKIP_PO_PROCESSING=True -G Ninja -DCMAKE_INSTALL_PREFIX=$CI_PROJECT_DIR/_install -DKF6DocTools_FOUND=false $CI_PROJECT_DIR
  - ninja -k 0
 artifacts: null

# Note: add WarningsAsErrors to .clang-tidy if you want to error on clang-tidy issues
build_clangtidy:
 extends:
  - .ci_linux_base
  - .suse_tumbleweed_qt6stable
 rules:
  # only run on merge requests
  - if: $CI_PIPELINE_SOURCE == "merge_request_event"
 variables:
    CC: clang
    CXX: clang++
 script:
  - git config --global --add safe.directory $CI_PROJECT_DIR
  - python3 -u ci-utilities/run-ci-build.py --project $CI_PROJECT_NAME --branch $CI_COMMIT_REF_NAME --platform Linux/Qt6/Shared --only-setup-environment
  - mkdir -p /tmp/$CI_PROJECT_NAME-tidy-build
  - cd /tmp/$CI_PROJECT_NAME-tidy-build
  - cmake -DCMAKE_CXX_CLANG_TIDY=clang-tidy -DENABLE_PCH=OFF -DKF_SKIP_PO_PROCESSING=True -G Ninja -DCMAKE_INSTALL_PREFIX=$CI_PROJECT_DIR/_install -DKF6DocTools_FOUND=false $CI_PROJECT_DIR
  - cp "$CI_PROJECT_DIR/.clang-tidy" .
  - ninja -k 0
 artifacts: null
